
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GantManager Pro - VadHorapp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --background-dark: #1a1a1a;
            --surface-dark: #2d3748;
            --surface-light: #4a5568;
            --text-primary: #ffffff;
            --text-secondary: #cbd5e0;
            --text-muted: #a0aec0;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, #2d3748 50%, var(--background-dark) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: auto;
        }
        
        .header {
            background: linear-gradient(135deg, var(--surface-dark) 0%, var(--secondary-color) 100%);
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow-heavy);
            border-bottom: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(52, 152, 219, 0.1) 50%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), #5dade2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        .container {
            max-width: 1800px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        
        .toolbar {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-medium);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1.5rem;
            align-items: start;
        }
        
        .toolbar-left {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        .toolbar-right {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: end;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #5dade2);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
            color: #2c3e50;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        
        .file-input {
            display: inline-block;
            cursor: pointer;
        }
        
        .file-input input {
            display: none;
        }
        
        .search-filter-container {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-medium);
        }
        
        .search-container {
            margin-bottom: 1rem;
        }
        
        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active,
        .filter-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }
        
        .stats-container {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-medium);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .progress-container {
            margin-top: 1rem;
        }

        /* Détails du projet (nom, description, notes) affichés sous la barre d'outils */
        .project-details {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-medium);
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        .project-details h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .project-details p {
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #58d68d);
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s ease-in-out infinite;
        }
        
        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .gantt-container {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-medium);
            overflow: hidden;
        }
        
        .gantt-header {
            display: flex;
            background: linear-gradient(135deg, var(--surface-dark), var(--secondary-color));
            border-bottom: 2px solid var(--primary-color);
            color: var(--text-primary);
        }
        
        .task-column {
            width: 500px;
            padding: 1rem;
            font-weight: 700;
            font-size: 1.1rem;
            border-right: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .timeline-column {
            flex: 1;
            padding: 1rem;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .date-labels {
            display: flex;
            background: rgba(45, 55, 72, 0.8);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .date-labels .task-column {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
        }
        
        .date-label {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-right: 1px solid var(--border-color);
            font-weight: 500;
        }
        
        .gantt-body {
            max-height: 800px;
            overflow-y: auto;
            background: rgba(26, 32, 44, 0.8);
        }
        
        .gantt-row {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            min-height: 80px;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .gantt-row:hover {
            background: rgba(52, 152, 219, 0.08);
            transform: scale(1.005);
            box-shadow: inset 0 0 0 1px rgba(52, 152, 219, 0.2);
        }
        
        .task-cell {
            width: 500px;
            padding: 1rem;
            border-right: 1px solid var(--border-color);
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .timeline-cell {
            flex: 1;
            padding: 0.5rem;
            position: relative;
            height: 80px;
            min-height: 80px;
        }
        
        .task-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .task-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-color);
            border-radius: 4px;
        }
        
        .task-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.3;
        }
        
        .task-name.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .task-name.phase {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .task-name.milestone {
            color: var(--warning-color);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .task-details {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }
        
        .task-duration {
            background: rgba(52, 152, 219, 0.2);
            color: var(--primary-color);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .critical-badge {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
        }

        /* Indicateurs pour les tâches en retard ou proches de l'échéance */
        .overdue-badge {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
        }
        .dueSoon-badge {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
            color: #2c3e50;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(243, 156, 18, 0.3);
        }

        /* Styles pour le macro planning inter‑projets */
        .macro-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .macro-name {
            width: 200px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .macro-bar-container {
            flex: 1;
            position: relative;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }
        .macro-bar {
            position: absolute;
            top: 0;
            height: 100%;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }
        .macro-milestone {
            position: absolute;
            top: 4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--warning-color);
            box-shadow: 0 0 4px rgba(243, 156, 18, 0.8);
        }
        
        .task-resources {
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .task-note {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid var(--warning-color);
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--warning-color);
            line-height: 1.4;
        }
        
        .task-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .control-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .control-btn:hover {
            transform: translateY(-1px);
        }
        
        .edit-btn {
            background: var(--primary-color);
            color: white;
        }
        
        .note-btn {
            background: var(--warning-color);
            color: white;
        }
        
        .delete-btn {
            background: var(--danger-color);
            color: white;
        }
        
        .task-bar {
            height: 32px;
            border-radius: 16px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            cursor: move;
        }
        
        .task-bar:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: var(--shadow-medium);
        }
        
        .task-bar.critical {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }
        
        .task-bar.normal {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }
        
        .task-bar.phase {
            background: linear-gradient(135deg, var(--primary-color), #5dade2);
            height: 28px;
            font-weight: 700;
        }
        
        .task-bar.milestone {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
            height: 40px;
            width: 40px !important;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4);
        }
        
        .task-bar.completed {
            opacity: 0.5;
            background: linear-gradient(135deg, #95a5a6, #bdc3c7) !important;
        }
        
        .task-bar.completed::after {
            content: "✓";
            position: absolute;
            right: 0.5rem;
            font-weight: bold;
            color: white;
        }

        /*
         * Classes pour indiquer les tâches proches de leur échéance ou en retard.
         * Ces couleurs surchargent uniquement les tâches normales afin de ne pas
         * perturber l'apparence des phases ou des jalons. Les tâches terminées
         * ne sont pas concernées.
         */
        .task-bar.due-soon:not(.milestone):not(.phase) {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
            color: #2c3e50;
        }
        .task-bar.overdue:not(.milestone):not(.phase) {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }
        
        .phase-row {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            border-left: 4px solid var(--primary-color);
        }
        
        .milestone-row {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(243, 156, 18, 0.05));
            border-left: 4px solid var(--warning-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--surface-dark), var(--secondary-color));
            margin: 3% auto;
            padding: 2rem;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            color: var(--text-primary);
            box-shadow: var(--shadow-heavy);
            animation: slideIn 0.3s ease;
            position: relative;
            /* Permettre le défilement interne lorsque le formulaire est long */
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color), var(--warning-color));
        }
        
        .modal h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .close {
            color: var(--text-muted);
            float: right;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: all 0.3s ease;
        }
        
        .close:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: var(--shadow-medium);
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }
        
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .empty-state-subtitle {
            font-size: 1rem;
            opacity: 0.7;
        }
        
        .today-indicator {
            position: absolute;
            width: 3px;
            height: 100%;
            background: var(--danger-color);
            z-index: 100;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        
        @media (max-width: 1200px) {
            .task-column {
                width: 400px;
            }
            
            .task-cell {
                width: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .toolbar {
                grid-template-columns: 1fr;
            }
            
            .toolbar-right {
                align-items: start;
            }
            
            .task-column,
            .task-cell {
                width: 300px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
        
        @media print {
            .toolbar,
            .search-filter-container,
            .stats-container .progress-container,
            .task-controls,
            .notification { 
                display: none !important; 
            }
            
            body {
                background: white !important;
                color: #333 !important;
            }
            
            .gantt-container,
            .gantt-header,
            .gantt-body {
                background: white !important;
                color: #333 !important;
                box-shadow: none !important;
            }
        /* S'assurer que l'intégralité du Gantt est visible à l'impression */
        .gantt-body {
            max-height: none !important;
            overflow: visible !important;
        }
            
            .task-bar {
                border: 1px solid #ddd !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>⚡ GantManager Pro</h1>
        <p class="subtitle">VadHorapp - Gestion de projets avancée</p>
    </div>
    
    <div class="container">
        <div class="toolbar">
            <div class="toolbar-left">
                <label class="file-input btn btn-primary">
                    📁 Importer
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
                </label>
                <!-- Sélecteur de projet -->
                <select id="projectSelect" onchange="switchProject(this.value)" style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.05); color: var(--text-primary); font-weight: 600; margin-right: 0.5rem;">
                    <option value="">Sélectionner projet</option>
                </select>
                <!-- Bouton pour créer un nouveau projet -->
                <button onclick="showAddProjectModal()" class="btn btn-primary">
                    🆕 Nouveau projet
                </button>
                <!-- Bouton pour gérer les ressources -->
                <button onclick="showResourceModal()" class="btn btn-success">
                    👥 Ressources
                </button>
                <button onclick="showDecomposeModal()" class="btn btn-primary">
                    🧠 Décomposer
                </button>
                <!-- Assistant de création de projet -->
                <button onclick="showMethodModal()" class="btn btn-primary">
                    🧩 Assistant projet
                </button>
                <!-- Macro planning inter‑projets -->
                <button onclick="showMacroModal()" class="btn btn-primary">
                    🗓️ Macro planning
                </button>
                <button onclick="showAddTaskModal()" class="btn btn-success">
                    ➕ Nouvelle tâche
                </button>
                <!-- Bouton pour créer rapidement un jalon (milestone) -->
                <button onclick="showAddTaskModal('milestone')" class="btn btn-warning">
                    🏆 Nouveau jalon
                </button>
                <button onclick="generateGantt()" class="btn btn-primary">
                    🔄 Actualiser
                </button>
                <!-- Bouton pour réinitialiser le planning du projet courant -->
                <button onclick="resetPlanning()" class="btn btn-danger">
                    🗑️ Vider planning
                </button>
            </div>
            <div class="toolbar-right">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="exportToExcel()" class="btn btn-success">
                        📊 Excel
                    </button>
                    <button onclick="exportToCSV()" class="btn btn-success">
                        📄 CSV
                    </button>
                    <button onclick="exportToPDF()" class="btn btn-warning">
                        🖨️ PDF
                    </button>
                    <button onclick="emailExport()" class="btn btn-primary">
                        📧 Email
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Détails du projet courant -->
        <div id="projectDetails" class="project-details" style="display: none;">
            <h3>Détails du projet</h3>
            <p><strong>Nom :</strong> <span id="projName"></span></p>
            <p><strong>Description :</strong> <span id="projDescription"></span></p>
            <p><strong>Notes :</strong> <span id="projNotes"></span></p>
        </div>

        <div class="search-filter-container">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="🔍 Rechercher tâches, ressources, notes...">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterTasks('all')">📋 Toutes</button>
                <button class="filter-btn" onclick="filterTasks('critical')">🚨 Critiques</button>
                <button class="filter-btn" onclick="filterTasks('completed')">✅ Terminées</button>
                <button class="filter-btn" onclick="filterTasks('pending')">⏳ En cours</button>
                <button class="filter-btn" onclick="filterTasks('phases')">🎯 Phases</button>
                <button class="filter-btn" onclick="filterTasks('milestones')">🏆 Jalons</button>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTasks">0</div>
                    <div class="stat-label">Total tâches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completedTasks">0</div>
                    <div class="stat-label">Terminées</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="criticalTasks">0</div>
                    <div class="stat-label">Critiques</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="teamMembers">0</div>
                    <div class="stat-label">Ressources</div>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="projectProgress" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0% du projet terminé</div>
            </div>
        </div>
        
        <div class="gantt-container" id="ganttContainer">
            <!-- Le contenu sera généré par JavaScript -->
        </div>
    </div>

    <!-- Modal pour ajouter/modifier une tâche -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Nouvelle tâche</h2>
            <form id="taskForm">
                <div class="form-group">
                    <label for="taskName">Nom de la tâche *</label>
                    <input type="text" id="taskName" required>
                </div>
                
                <div class="form-group">
                    <label for="taskType">Type</label>
                    <select id="taskType">
                        <option value="normal">Tâche normale</option>
                        <option value="phase">Phase</option>
                        <option value="milestone">Jalon</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="startDate">Date de début</label>
                    <input type="date" id="startDate" required>
                </div>
                
                <div class="form-group">
                    <label for="endDate">Date de fin</label>
                    <input type="date" id="endDate" required>
                </div>
                
                <div class="form-group">
                    <label for="resources">Ressources</label>
                    <!-- Champ ressource avec suggestions -->
                    <input type="text" id="resources" list="resourceOptions" placeholder="Nom des responsables (séparés par virgule)">
                    <datalist id="resourceOptions"></datalist>
                </div>
                
                <div class="form-group">
                    <label for="priority">Priorité</label>
                    <select id="priority">
                        <option value="normal">Normale</option>
                        <option value="critical">Critique</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="progress">Progression (%)</label>
                    <input type="number" id="progress" min="0" max="100" value="0">
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="3" placeholder="Commentaires ou instructions..."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 2rem;">
                    <button type="button" onclick="closeModal()" class="btn btn-warning">Annuler</button>
                    <button type="submit" class="btn btn-success">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour ajouter/modifier un projet -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProjectModal()">&times;</span>
            <h2 id="projectModalTitle">Nouveau projet</h2>
            <form id="projectForm">
                <div class="form-group">
                    <label for="projectName">Nom du projet *</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label for="projectStart">Date de début</label>
                    <input type="date" id="projectStart">
                </div>
                <div class="form-group">
                    <label for="projectEnd">Date de fin</label>
                    <input type="date" id="projectEnd">
                </div>
                <div class="form-group">
                    <label for="projectDescription">Description</label>
                    <textarea id="projectDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="projectNotes">Notes du projet</label>
                    <textarea id="projectNotes" rows="3" placeholder="Notes libres pour ce projet"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 2rem;">
                    <button type="button" onclick="closeProjectModal()" class="btn btn-warning">Annuler</button>
                    <button type="submit" class="btn btn-success">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour gérer les ressources -->
    <div id="resourceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResourceModal()">&times;</span>
            <h2>Gestion des ressources</h2>
            <!-- Liste des ressources -->
            <div id="resourceList" style="margin-bottom: 1rem;"></div>
            <form id="resourceForm">
                <div class="form-group">
                    <label for="newResource">Ajouter une ressource</label>
                    <input type="text" id="newResource" placeholder="Nom de la ressource">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: end;">
                    <button type="button" onclick="closeResourceModal()" class="btn btn-warning">Fermer</button>
                    <button type="submit" class="btn btn-success">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour décomposer un problème complexe en tâches -->
    <div id="decomposeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDecomposeModal()">&times;</span>
            <h2>Décomposition de problème</h2>
            <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                Décrivez votre problème complexe et séparez chaque étape ou tâche sur une nouvelle ligne. Vous pouvez aussi
                spécifier la date de début et la durée pour planifier automatiquement les tâches générées.
            </p>
            <form id="decomposeForm">
                <div class="form-group">
                    <label for="problemText">Description du problème *</label>
                    <textarea id="problemText" rows="5" placeholder="Chaque ligne sera convertie en une tâche distincte"></textarea>
                </div>
                <div class="form-group">
                    <label for="decomposeStartDate">Date de début des tâches</label>
                    <input type="date" id="decomposeStartDate">
                </div>
                <div class="form-group">
                    <label for="decomposeDuration">Durée (jours) par tâche</label>
                    <input type="number" id="decomposeDuration" value="5" min="1" max="365">
                </div>
                <div class="form-group">
                    <label for="decomposeType">Type de tâches générées</label>
                    <select id="decomposeType">
                        <option value="normal">Tâche normale</option>
                        <option value="phase">Phase</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 2rem;">
                    <button type="button" onclick="closeDecomposeModal()" class="btn btn-warning">Annuler</button>
                    <button type="submit" class="btn btn-success">Décomposer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour assistant de création de projet selon une méthode -->
    <div id="methodModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMethodModal()">&times;</span>
            <h2>Assistant projet</h2>
            <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                Sélectionnez une méthodologie reconnue pour générer automatiquement des phases de projet. Vous pouvez
                définir la date de début et la durée de chaque phase.
            </p>
            <form id="methodForm">
                <div class="form-group">
                    <label for="methodSelect">Méthodologie</label>
                    <select id="methodSelect" required>
                        <option value="">-- Choisir une méthode --</option>
                        <option value="waterfall">Cycle en cascade (Waterfall)</option>
                        <option value="agile">Scrum / Agile</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="methodStartDate">Date de début du projet</label>
                    <input type="date" id="methodStartDate">
                </div>
                <div class="form-group">
                    <label for="methodPhaseDuration">Durée (jours) par phase</label>
                    <input type="number" id="methodPhaseDuration" value="10" min="1" max="365">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 2rem;">
                    <button type="button" onclick="closeMethodModal()" class="btn btn-warning">Annuler</button>
                    <button type="submit" class="btn btn-success">Générer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour macro planning inter‑projets -->
    <div id="macroModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeMacroModal()">&times;</span>
            <h2>Macro planning des projets</h2>
            <div id="macroContainer" style="margin-top: 1.5rem;"></div>
        </div>
    </div>

    <script>
        // Données globales
        let tasks = [];
        let currentFilter = 'all';
        let editingTask = null;
        // Gestion multi-projets et ressources
        let projects = [];
        let currentProjectId = null;
        let resourcesList = [];

        // Données du projet Messagerie Sécurisée OCE
        const demoTasks = [
            // PHASE 1 - Sécurisation Fondamentaux
            {
                id: 1,
                name: "Phase 1 - Sécurisation Fondamentaux",
                type: "phase",
                startDate: "2025-08-12",
                endDate: "2025-08-25",
                resources: "Équipe Projet",
                priority: "critical",
                progress: 0,
                notes: "Arbitrages + procédures + impact RH"
            },
            {
                id: 2,
                name: "Réunion cadrage métier processus",
                type: "normal",
                startDate: "2025-08-12",
                endDate: "2025-08-12",
                resources: "ORPi, Accueil, Conseil",
                priority: "critical",
                progress: 0,
                notes: "Liste 15 processus hiérarchisés"
            },
            {
                id: 3,
                name: "Arbitrages juridiques définitifs",
                type: "normal",
                startDate: "2025-08-12",
                endDate: "2025-08-19",
                resources: "Direction Juridique, OCSIN",
                priority: "critical",
                progress: 0,
                notes: "Note juridique définitive"
            },
            {
                id: 4,
                name: "Formalisation procédures dégradées",
                type: "normal",
                startDate: "2025-08-12",
                endDate: "2025-08-18",
                resources: "ORPi, Conseil",
                priority: "critical",
                progress: 0,
                notes: "Document procédures + critères"
            },
            {
                id: 5,
                name: "Évaluation impact macros",
                type: "normal",
                startDate: "2025-08-13",
                endDate: "2025-08-16",
                resources: "Expert Macro",
                priority: "normal",
                progress: 0,
                notes: "Rapport impact + estimation"
            },
            {
                id: 6,
                name: "Mesure référentiel temps processus",
                type: "normal",
                startDate: "2025-08-12",
                endDate: "2025-08-16",
                resources: "Chefs service, Équipes",
                priority: "normal",
                progress: 0,
                notes: "Référentiel temps avant transformation"
            },
            {
                id: 7,
                name: "Adaptation processus inscription V.0",
                type: "normal",
                startDate: "2025-08-19",
                endDate: "2025-08-25",
                resources: "ORPi",
                priority: "critical",
                progress: 0,
                notes: "Processus inscription révisé"
            },

            // PHASE 2 - Développement Outils Formation
            {
                id: 8,
                name: "Phase 2 - Développement Outils Formation",
                type: "phase",
                startDate: "2025-08-19",
                endDate: "2025-09-06",
                resources: "Équipe Projet",
                priority: "normal",
                progress: 0,
                notes: "Supports + formation + groupe pilote"
            },
            {
                id: 9,
                name: "Création supports communication DE",
                type: "normal",
                startDate: "2025-08-19",
                endDate: "2025-08-30",
                resources: "Communication, ORPi",
                priority: "normal",
                progress: 0,
                notes: "Fiche explicative A4 recto-verso"
            },
            {
                id: 10,
                name: "Développement aide-mémoire conseillers",
                type: "normal",
                startDate: "2025-08-19",
                endDate: "2025-08-30",
                resources: "ORPi, Experts métier",
                priority: "normal",
                progress: 0,
                notes: "Document synthèse 1 page + FAQ"
            },
            {
                id: 11,
                name: "Quantification impact charge RH",
                type: "normal",
                startDate: "2025-08-26",
                endDate: "2025-09-06",
                resources: "Chefs service, Direction",
                priority: "critical",
                progress: 0,
                notes: "Rapport dimensionnement + propositions"
            },
            {
                id: 12,
                name: "Préparation formation équipes",
                type: "normal",
                startDate: "2025-08-26",
                endDate: "2025-09-06",
                resources: "ORPi, Communication",
                priority: "normal",
                progress: 0,
                notes: "Programme 2h + supports pédagogiques"
            },
            {
                id: 13,
                name: "Validation supports par Direction",
                type: "normal",
                startDate: "2025-09-02",
                endDate: "2025-09-06",
                resources: "Direction, Communication",
                priority: "critical",
                progress: 0,
                notes: "Approbation définitive supports"
            },

            // PHASE 3 - Déploiement Tests
            {
                id: 14,
                name: "Phase 3 - Déploiement Tests",
                type: "phase",
                startDate: "2025-09-02",
                endDate: "2025-09-30",
                resources: "Équipe Projet",
                priority: "normal",
                progress: 0,
                notes: "Tests + équipes + procédures ajustées"
            },
            {
                id: 15,
                name: "Information équipes internes",
                type: "normal",
                startDate: "2025-09-02",
                endDate: "2025-09-06",
                resources: "Managers, Équipes",
                priority: "normal",
                progress: 0,
                notes: "Briefing tous services + accusés"
            },
            {
                id: 16,
                name: "Formation vague 1 conseillers",
                type: "normal",
                startDate: "2025-09-09",
                endDate: "2025-09-20",
                resources: "50% conseillers, Formateurs",
                priority: "critical",
                progress: 0,
                notes: "Équipes formées + évaluation acquis"
            },
            {
                id: 17,
                name: "Constitution groupe pilote DE",
                type: "normal",
                startDate: "2025-09-02",
                endDate: "2025-09-13",
                resources: "Conseillers désignés",
                priority: "normal",
                progress: 0,
                notes: "Liste 50 DE volontaires comptes vérifiés"
            },
            {
                id: 18,
                name: "Déploiement communication externe",
                type: "normal",
                startDate: "2025-09-09",
                endDate: "2025-09-27",
                resources: "Communication, Services supports",
                priority: "normal",
                progress: 0,
                notes: "Affichage + fiches + mailing réalisés"
            },
            {
                id: 19,
                name: "Tests procédures avec groupe pilote",
                type: "normal",
                startDate: "2025-09-16",
                endDate: "2025-09-30",
                resources: "ORPi, OCSIN, Groupe pilote",
                priority: "critical",
                progress: 0,
                notes: "Rapport tests + dysfonctionnements + corrections"
            },
            {
                id: 20,
                name: "Formation vague 2 conseillers",
                type: "normal",
                startDate: "2025-09-23",
                endDate: "2025-09-30",
                resources: "50% restants conseillers",
                priority: "critical",
                progress: 0,
                notes: "Formation complète toutes équipes"
            },

            // PHASE 4 - Consolidation Préparation GoLive
            {
                id: 21,
                name: "Phase 4 - Consolidation Préparation GoLive",
                type: "phase",
                startDate: "2025-10-01",
                endDate: "2025-10-15",
                resources: "Équipe Projet",
                priority: "normal",
                progress: 0,
                notes: "Suivi + équipes prêtes + continuité"
            },
            {
                id: 22,
                name: "Ajustements procédures post-tests",
                type: "normal",
                startDate: "2025-10-01",
                endDate: "2025-10-08",
                resources: "ORPi, Retours groupe pilote",
                priority: "critical",
                progress: 0,
                notes: "Procédures définitives ajustées"
            },
            {
                id: 23,
                name: "Formation équipes accueil spécialisée",
                type: "normal",
                startDate: "2025-10-01",
                endDate: "2025-10-08",
                resources: "Équipes accueil",
                priority: "normal",
                progress: 0,
                notes: "Équipes formées cas particuliers"
            },
            {
                id: 24,
                name: "Mise en place dispositif suivi performance",
                type: "normal",
                startDate: "2025-10-06",
                endDate: "2025-10-10",
                resources: "OCSIN, Services supports",
                priority: "critical",
                progress: 0,
                notes: "Tableau bord + indicateurs + seuils"
            },
            {
                id: 25,
                name: "Validation finale go-live production",
                type: "normal",
                startDate: "2025-10-13",
                endDate: "2025-10-15",
                resources: "Direction, OCSIN, ORPi",
                priority: "critical",
                progress: 0,
                notes: "Décision go-live + date production"
            },

            // JALONS
            {
                id: 26,
                name: "JALON 1 - Validation Fondamentaux",
                type: "milestone",
                startDate: "2025-08-19",
                endDate: "2025-08-19",
                resources: "Direction",
                priority: "critical",
                progress: 0,
                notes: "Arbitrages + procédures + impact RH"
            },
            {
                id: 27,
                name: "JALON 2 - Validation Outils Formation",
                type: "milestone",
                startDate: "2025-09-06",
                endDate: "2025-09-06",
                resources: "Direction",
                priority: "critical",
                progress: 0,
                notes: "Supports + formation + groupe pilote"
            },
            {
                id: 28,
                name: "JALON 3 - Validation Préparation",
                type: "milestone",
                startDate: "2025-09-30",
                endDate: "2025-09-30",
                resources: "Direction",
                priority: "critical",
                progress: 0,
                notes: "Tests + équipes + procédures ajustées"
            },
            {
                id: 29,
                name: "JALON 4 - Décision GoLive",
                type: "milestone",
                startDate: "2025-10-15",
                endDate: "2025-10-15",
                resources: "Direction",
                priority: "critical",
                progress: 0,
                notes: "Suivi + équipes prêtes + continuité"
            }
        ];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Créer un projet par défaut avec les tâches de démonstration
            const defaultProject = {
                id: Date.now(),
                // Utiliser un nom explicite pour le projet initial.  Le client a
                // indiqué que le projet de démonstration s'appelle
                // « Messagerie sécurisée ».  Ce nom sera affiché dans la liste
                // déroulante des projets et dans le macro‑planning.
                name: 'Messagerie sécurisée',
                tasks: [...demoTasks],
                startDate: '',
                endDate: '',
                description: '',
                notes: ''
            };
            projects.push(defaultProject);
            currentProjectId = defaultProject.id;
            tasks = defaultProject.tasks;

            // Construire la liste des ressources initiales à partir des tâches
            updateResourcesFromTasks();

            // Configurer les événements
            setupEventListeners();

            // Mettre à jour la liste déroulante des projets
            renderProjectSelect();

            // Générer la liste des suggestions de ressources
            renderResourceOptions();

            // Générer le Gantt initial
            generateGantt();

            // Mettre à jour les statistiques
            updateStats();

            // Afficher les détails du projet par défaut
            renderProjectDetails();

            // Définir la date de début par défaut pour le formulaire de tâches
            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('endDate').value = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        });

        function setupEventListeners() {
            // Recherche en temps réel
            document.getElementById('searchInput').addEventListener('input', function(e) {
                searchTasks(e.target.value);
            });

            // Import de fichier
            document.getElementById('fileInput').addEventListener('change', handleFileImport);

            // Formulaire de tâche
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);

            // Formulaire de projet
            const projectForm = document.getElementById('projectForm');
            if (projectForm) {
                projectForm.addEventListener('submit', handleProjectSubmit);
            }

            // Formulaire de ressource
            const resForm = document.getElementById('resourceForm');
            if (resForm) {
                resForm.addEventListener('submit', handleResourceSubmit);
            }

            // Formulaire de décomposition
            const decomposeForm = document.getElementById('decomposeForm');
            if (decomposeForm) {
                decomposeForm.addEventListener('submit', handleDecomposeSubmit);
            }

            // Formulaire de l'assistant projet
            const methodForm = document.getElementById('methodForm');
            if (methodForm) {
                methodForm.addEventListener('submit', handleMethodSubmit);
            }

            // Fermer modals en cliquant à l'extérieur
            window.addEventListener('click', function(e) {
                const taskModal = document.getElementById('taskModal');
                const projectModalEl = document.getElementById('projectModal');
                const resourceModalEl = document.getElementById('resourceModal');
                const decomposeModalEl = document.getElementById('decomposeModal');
                const methodModalEl = document.getElementById('methodModal');
                const macroModalEl = document.getElementById('macroModal');
                if (e.target === taskModal) {
                    closeModal();
                }
                if (e.target === projectModalEl) {
                    closeProjectModal();
                }
                if (e.target === resourceModalEl) {
                    closeResourceModal();
                }
                if (e.target === decomposeModalEl) {
                    closeDecomposeModal();
                }
                if (e.target === methodModalEl) {
                    closeMethodModal();
                }
                if (e.target === macroModalEl) {
                    closeMacroModal();
                }
            });
        }

        /**
         * Affiche le formulaire d’ajout de tâche.  La fonction accepte un type de
         * tâche optionnel (normal, phase ou milestone) pour pré‑remplir le
         * formulaire.  Lorsqu’un jalon est demandé, les dates de début et de fin
         * sont alignées pour représenter un événement ponctuel, et le titre du
         * formulaire est adapté.
         *
         * @param {string|null} presetType
         */
        function showAddTaskModal(presetType = null) {
            editingTask = null;
            const modalTitleEl = document.getElementById('modalTitle');
            // Ajuster le titre selon le type
            if (presetType === 'milestone') {
                modalTitleEl.textContent = 'Nouveau jalon';
            } else {
                modalTitleEl.textContent = 'Nouvelle tâche';
            }
            // Remise à zéro du formulaire
            document.getElementById('taskForm').reset();
            // Dates par défaut
            const todayStr = new Date().toISOString().split('T')[0];
            const oneWeekLater = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('startDate').value = todayStr;
            document.getElementById('endDate').value = oneWeekLater;
            // Pré‑sélection du type
            if (presetType) {
                const typeSelect = document.getElementById('taskType');
                if (typeSelect) typeSelect.value = presetType;
                if (presetType === 'milestone') {
                    document.getElementById('endDate').value = todayStr;
                }
            }
            document.getElementById('taskModal').style.display = 'block';
        }
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTask = task;
            document.getElementById('modalTitle').textContent = 'Modifier la tâche';
            
            // Remplir le formulaire
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskType').value = task.type;
            document.getElementById('startDate').value = task.startDate;
            document.getElementById('endDate').value = task.endDate;
            document.getElementById('resources').value = task.resources;
            document.getElementById('priority').value = task.priority;
            document.getElementById('progress').value = task.progress;
            document.getElementById('notes').value = task.notes || '';
            
            document.getElementById('taskModal').style.display = 'block';
        }

        function deleteTask(taskId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                updateResourcesFromTasks();
                renderResourceOptions();
                generateGantt();
                updateStats();
                showNotification('Tâche supprimée avec succès', 'success');
            }
        }

        function toggleTaskComplete(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.progress = task.progress === 100 ? 0 : 100;
                generateGantt();
                updateStats();
            }
        }

        function closeModal() {
            document.getElementById('taskModal').style.display = 'none';
        }

        function handleTaskSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('taskName').value,
                type: document.getElementById('taskType').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                resources: document.getElementById('resources').value,
                priority: document.getElementById('priority').value,
                progress: parseInt(document.getElementById('progress').value),
                notes: document.getElementById('notes').value
            };

            if (editingTask) {
                // Modifier la tâche existante
                Object.assign(editingTask, formData);
                showNotification('Tâche modifiée avec succès', 'success');
            } else {
                // Ajouter une nouvelle tâche
                const newTask = {
                    id: Date.now(),
                    ...formData
                };
                tasks.push(newTask);
                showNotification('Tâche ajoutée avec succès', 'success');
            }

            // Mettre à jour la liste des ressources en fonction des nouvelles tâches
            updateResourcesFromTasks();
            renderResourceOptions();
            closeModal();
            generateGantt();
            updateStats();
        }

        function generateGantt() {
            const container = document.getElementById('ganttContainer');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <div class="empty-state-text">Aucune tâche</div>
                        <div class="empty-state-subtitle">Ajoutez votre première tâche pour commencer</div>
                    </div>
                `;
                return;
            }

            // Filtrer les tâches
            const filteredTasks = getFilteredTasks();
            
            // Calculer la plage de dates
            const dateRange = calculateDateRange(filteredTasks);
            const timelineWidth = calculateTimelineWidth(dateRange);

            // Générer l'en-tête
            const header = generateHeader(dateRange);
            
            // Générer les lignes de tâches
            const rows = filteredTasks.map(task => generateTaskRow(task, dateRange, timelineWidth)).join('');

            container.innerHTML = `
                ${header}
                <div class="gantt-body">
                    ${rows}
                </div>
            `;
        }

        function getFilteredTasks() {
            let filtered = [...tasks];
            
            // Appliquer le filtre de type
            switch (currentFilter) {
                case 'critical':
                    filtered = filtered.filter(t => t.priority === 'critical');
                    break;
                case 'completed':
                    filtered = filtered.filter(t => t.progress === 100);
                    break;
                case 'pending':
                    filtered = filtered.filter(t => t.progress < 100);
                    break;
                case 'phases':
                    filtered = filtered.filter(t => t.type === 'phase');
                    break;
                case 'milestones':
                    filtered = filtered.filter(t => t.type === 'milestone');
                    break;
            }

            // Appliquer le filtre de recherche
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(task => 
                    task.name.toLowerCase().includes(searchTerm) ||
                    task.resources.toLowerCase().includes(searchTerm) ||
                    (task.notes && task.notes.toLowerCase().includes(searchTerm))
                );
            }

            return filtered;
        }

        function calculateDateRange(tasks) {
            if (tasks.length === 0) {
                const today = new Date();
                return {
                    start: new Date(today.getFullYear(), today.getMonth(), 1),
                    end: new Date(today.getFullYear(), today.getMonth() + 3, 0)
                };
            }

            const dates = tasks.flatMap(task => [new Date(task.startDate), new Date(task.endDate)]);
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            // Ajouter une marge
            minDate.setDate(minDate.getDate() - 7);
            maxDate.setDate(maxDate.getDate() + 7);
            
            return { start: minDate, end: maxDate };
        }

        function calculateTimelineWidth(dateRange) {
            const daysDiff = Math.ceil((dateRange.end - dateRange.start) / (1000 * 60 * 60 * 24));
            return Math.max(daysDiff * 30, 800); // Minimum 800px
        }

        function generateHeader(dateRange) {
            const weeks = generateWeekLabels(dateRange);
            const weekLabels = weeks.map(week => `<div class="date-label">${week}</div>`).join('');

            return `
                <div class="gantt-header">
                    <div class="task-column">📋 Tâches</div>
                    <div class="timeline-column">📅 Chronologie</div>
                </div>
                <div class="date-labels">
                    <div class="task-column">Détails</div>
                    ${weekLabels}
                </div>
            `;
        }

        function generateWeekLabels(dateRange) {
            const weeks = [];
            const current = new Date(dateRange.start);
            
            while (current <= dateRange.end) {
                const weekStart = new Date(current);
                const weekEnd = new Date(current);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                weeks.push(`${formatShortDate(weekStart)} - ${formatShortDate(weekEnd)}`);
                current.setDate(current.getDate() + 7);
            }
            
            return weeks;
        }

        function generateTaskRow(task, dateRange, timelineWidth) {
            const taskBarStyle = calculateTaskBarStyle(task, dateRange, timelineWidth);
            const rowClass = task.type === 'phase' ? 'phase-row' : task.type === 'milestone' ? 'milestone-row' : '';
            const completedClass = task.progress === 100 ? 'completed' : '';
            // Déterminer la classe en fonction de l'échéance (en retard ou proche)
            const dueClass = getDueClass(task);
            
            return `
                <div class="gantt-row ${rowClass}">
                    <div class="task-cell">
                        <div class="task-header">
                            <input type="checkbox" class="task-checkbox" 
                                   ${task.progress === 100 ? 'checked' : ''} 
                                   onchange="toggleTaskComplete(${task.id})">
                            <span class="task-name ${task.type} ${completedClass}">${task.name}</span>
                        </div>
                        
                        <div class="task-details">
                            <span class="task-duration">${calculateDuration(task)} jours</span>
                            ${task.priority === 'critical' ? '<span class="critical-badge">CRITIQUE</span>' : ''}
                            <span class="task-resources">👤 ${task.resources}</span>
                            ${dueClass === 'due-soon' && task.progress < 100 ? '<span class="dueSoon-badge">À échéance</span>' : ''}
                            ${dueClass === 'overdue' && task.progress < 100 ? '<span class="overdue-badge">EN RETARD</span>' : ''}
                        </div>
                        
                        ${task.notes ? `<div class="task-note">📝 ${task.notes}</div>` : ''}
                        
                        <div class="task-controls">
                            <button class="control-btn edit-btn" onclick="editTask(${task.id})">
                                ✏️ Modifier
                            </button>
                            <button class="control-btn delete-btn" onclick="deleteTask(${task.id})">
                                🗑️ Supprimer
                            </button>
                        </div>
                    </div>
                    
                    <div class="timeline-cell">
                        <div class="task-bar ${task.type} ${task.priority} ${dueClass} ${completedClass}" 
                             style="${taskBarStyle}"
                             title="${task.name} (${task.progress}%)">
                            ${task.type === 'milestone' ? '🏆' : task.name}
                            ${task.type !== 'milestone' ? `<span style="margin-left: auto;">${task.progress}%</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateTaskBarStyle(task, dateRange, timelineWidth) {
            const startDate = new Date(task.startDate);
            const endDate = new Date(task.endDate);
            const rangeStart = dateRange.start;
            const totalDays = (dateRange.end - dateRange.start) / (1000 * 60 * 60 * 24);
            
            const startOffset = (startDate - rangeStart) / (1000 * 60 * 60 * 24);
            const duration = (endDate - startDate) / (1000 * 60 * 60 * 24) + 1;
            
            const leftPercent = (startOffset / totalDays) * 100;
            const widthPercent = (duration / totalDays) * 100;
            
            if (task.type === 'milestone') {
                return `left: ${leftPercent}%; transform: translateX(-50%);`;
            }
            
            return `left: ${leftPercent}%; width: ${widthPercent}%;`;
        }

        function calculateDuration(task) {
            const start = new Date(task.startDate);
            const end = new Date(task.endDate);
            return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        }

        /**
         * Détermine si une tâche est en retard ou proche de son échéance.
         * Une tâche terminée n'est jamais considérée comme en retard.
         * - 'overdue' : la date de fin est passée et la tâche n'est pas terminée.
         * - 'due-soon' : la date de fin est dans 3 jours ou moins et la tâche n'est pas terminée.
         * - '' : aucun statut particulier.
         * @param {Object} task L'objet tâche contenant les dates et l'avancement
         * @returns {string} La classe à appliquer sur la barre de tâche
         */
        function getDueClass(task) {
            if (!task || task.progress === 100) return '';
            const today = new Date();
            // Remise à zéro de l'heure pour éviter les effets de bord
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(task.endDate);
            endDate.setHours(0, 0, 0, 0);
            // Si la date de fin est avant aujourd'hui : en retard
            if (endDate < today) {
                return 'overdue';
            }
            const diffDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
            if (diffDays <= 3) {
                return 'due-soon';
            }
            return '';
        }

        function formatShortDate(date) {
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        }

        function filterTasks(filter) {
            currentFilter = filter;
            
            // Mettre à jour l'apparence des boutons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            generateGantt();
        }

        function searchTasks(searchTerm) {
            generateGantt();
        }

        function updateStats() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.progress === 100).length;
            const criticalTasks = tasks.filter(t => t.priority === 'critical').length;
            const resSet = new Set();
            tasks.forEach(t => {
                if (t.resources) {
                    t.resources.split(',').forEach(r => {
                        const trimmed = r.trim();
                        if (trimmed) resSet.add(trimmed);
                    });
                }
            });
            const uniqueResources = resSet.size;
            
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('criticalTasks').textContent = criticalTasks;
            document.getElementById('teamMembers').textContent = uniqueResources;
            
            document.getElementById('projectProgress').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}% du projet terminé`;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Fonctions d'export
        function exportToCSV() {
            const headers = ['Nom', 'Type', 'Début', 'Fin', 'Ressources', 'Priorité', 'Progression', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...tasks.map(task => [
                    `"${task.name}"`,
                    task.type,
                    task.startDate,
                    task.endDate,
                    `"${task.resources}"`,
                    task.priority,
                    task.progress,
                    `"${task.notes || ''}"`
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, 'gantt-project.csv', 'text/csv');
            showNotification('Export CSV réussi', 'success');
        }

        /**
         * Exporte les tâches du projet courant dans un fichier Excel (au format
         * HTML) lisible par les tableurs.  Génère un tableau avec toutes les
         * informations principales et déclenche un téléchargement d'un fichier
         * .xls.  Les caractères spéciaux sont échappés pour éviter toute
         * corruption du fichier.
         */
        function exportToExcel() {
            if (!tasks || tasks.length === 0) {
                showNotification('Aucune tâche à exporter', 'error');
                return;
            }
            // Fonction d'échappement pour le HTML
            const escapeHTML = (str) => {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };
            const headers = ['Nom', 'Type', 'Début', 'Fin', 'Ressources', 'Priorité', 'Progression (%)', 'Notes'];
            let table = '<table border="1" cellspacing="0" cellpadding="5">';
            table += '<thead><tr>' + headers.map(h => `<th>${escapeHTML(h)}</th>`).join('') + '</tr></thead>';
            table += '<tbody>';
            tasks.forEach(task => {
                table += '<tr>' + [
                    escapeHTML(task.name),
                    escapeHTML(task.type),
                    escapeHTML(task.startDate),
                    escapeHTML(task.endDate),
                    escapeHTML(task.resources),
                    escapeHTML(task.priority),
                    String(task.progress),
                    escapeHTML(task.notes || '')
                ].map(cell => `<td>${cell}</td>`).join('') + '</tr>';
            });
            table += '</tbody></table>';
            const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${table}</body></html>`;
            downloadFile(htmlContent, 'gantt_export.xls', 'application/vnd.ms-excel');
            showNotification('Export Excel réussi', 'success');
        }

        function exportToPDF() {
            window.print();
        }

        function emailExport() {
            const subject = encodeURIComponent('Planning de projet Gantt');
            const body = encodeURIComponent(`Bonjour,\n\nVeuillez trouver ci-joint le planning de projet.\n\nNombre de tâches: ${tasks.length}\nTâches terminées: ${tasks.filter(t => t.progress === 100).length}\n\nCordialement`);
            
            window.open(`mailto:?subject=${subject}&body=${body}`);
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.csv')) {
                        parseCSV(e.target.result);
                    } else {
                        showNotification('Format de fichier non supporté', 'error');
                    }
                } catch (error) {
                    showNotification('Erreur lors de l'+'import', 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            
            const importedTasks = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= 6) {
                    importedTasks.push({
                        id: Date.now() + i,
                        name: values[0].replace(/"/g, ''),
                        type: values[1] || 'normal',
                        startDate: values[2],
                        endDate: values[3],
                        resources: values[4].replace(/"/g, ''),
                        priority: values[5] || 'normal',
                        progress: parseInt(values[6]) || 0,
                        notes: values[7] ? values[7].replace(/"/g, '') : ''
                    });
                }
            }

            tasks = tasks.concat(importedTasks);
            updateResourcesFromTasks();
            renderResourceOptions();
            generateGantt();
            updateStats();
            showNotification(`${importedTasks.length} tâches importées`, 'success');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ------- Gestion des ressources -------
        function updateResourcesFromTasks() {
            resourcesList = [];
            tasks.forEach(task => {
                if (task.resources) {
                    task.resources.split(',').forEach(res => {
                        const trimmed = res.trim();
                        if (trimmed && !resourcesList.includes(trimmed)) {
                            resourcesList.push(trimmed);
                        }
                    });
                }
            });
        }

        function renderResourceOptions() {
            const dataList = document.getElementById('resourceOptions');
            if (!dataList) return;
            dataList.innerHTML = resourcesList.map(r => `<option value="${r}">`).join('');
        }

        function showResourceModal() {
            renderResourceList();
            const modal = document.getElementById('resourceModal');
            if (modal) modal.style.display = 'block';
            const input = document.getElementById('newResource');
            if (input) input.value = '';
        }

        function renderResourceList() {
            const container = document.getElementById('resourceList');
            if (!container) return;
            if (resourcesList.length === 0) {
                container.innerHTML = '<p>Aucune ressource ajoutée.</p>';
            } else {
                container.innerHTML = resourcesList.map((res, index) => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;border-bottom:1px solid var(--border-color);">
                        <span>${res}</span>
                        <button class="btn btn-danger" style="padding:0.25rem 0.5rem;font-size:0.7rem;" onclick="removeResource(${index})">Supprimer</button>
                    </div>
                `).join('');
            }
        }

        function closeResourceModal() {
            const modal = document.getElementById('resourceModal');
            if (modal) modal.style.display = 'none';
        }

        function handleResourceSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('newResource');
            if (!input) return;
            const newRes = input.value.trim();
            if (newRes && !resourcesList.includes(newRes)) {
                resourcesList.push(newRes);
                renderResourceList();
                renderResourceOptions();
                showNotification('Ressource ajoutée', 'success');
            }
            input.value = '';
        }

        function removeResource(index) {
            resourcesList.splice(index, 1);
            renderResourceList();
            renderResourceOptions();
        }

        // ------- Assistant de création de projet -------
        function showMethodModal() {
            const modal = document.getElementById('methodModal');
            if (!modal) return;
            // Initialise les champs par défaut
            const startInput = document.getElementById('methodStartDate');
            if (startInput) startInput.value = new Date().toISOString().split('T')[0];
            const durationInput = document.getElementById('methodPhaseDuration');
            if (durationInput) durationInput.value = 10;
            const methodSelect = document.getElementById('methodSelect');
            if (methodSelect) methodSelect.value = '';
            modal.style.display = 'block';
        }

        function closeMethodModal() {
            const modal = document.getElementById('methodModal');
            if (modal) modal.style.display = 'none';
        }

        function handleMethodSubmit(e) {
            e.preventDefault();
            const methodSelect = document.getElementById('methodSelect');
            if (!methodSelect || !methodSelect.value) {
                showNotification('Veuillez choisir une méthodologie', 'error');
                return;
            }
            const method = methodSelect.value;
            const startStr = document.getElementById('methodStartDate').value;
            const phaseDuration = parseInt(document.getElementById('methodPhaseDuration').value) || 10;
            if (!startStr) {
                showNotification('Veuillez choisir une date de début', 'error');
                return;
            }
            const startDate = new Date(startStr);
            let phases = [];
            if (method === 'waterfall') {
                phases = [
                    'Analyse des besoins',
                    'Conception',
                    'Développement',
                    'Tests',
                    'Déploiement'
                ];
            } else if (method === 'agile') {
                phases = [
                    'Sprint 1 - Planification et backlog',
                    'Sprint 2 - Développement et intégration',
                    'Sprint 3 - Tests et revue',
                    'Sprint 4 - Déploiement et rétrospective'
                ];
            }
            let currentStart = new Date(startDate);
            phases.forEach((phaseName, index) => {
                const phaseStart = new Date(currentStart);
                const phaseEnd = new Date(currentStart);
                phaseEnd.setDate(phaseEnd.getDate() + phaseDuration - 1);
                const newTask = {
                    id: Date.now() + index,
                    name: phaseName,
                    type: 'phase',
                    startDate: phaseStart.toISOString().split('T')[0],
                    endDate: phaseEnd.toISOString().split('T')[0],
                    resources: '',
                    priority: 'normal',
                    progress: 0,
                    notes: ''
                };
                tasks.push(newTask);
                currentStart.setDate(currentStart.getDate() + phaseDuration);
            });
            showNotification(`${phases.length} phases générées`, 'success');
            updateResourcesFromTasks();
            renderResourceOptions();
            generateGantt();
            updateStats();
            closeMethodModal();
        }

        // ------- Macro planning inter‑projets -------
        function showMacroModal() {
            generateMacroPlanning();
            const modal = document.getElementById('macroModal');
            if (modal) modal.style.display = 'block';
        }

        function closeMacroModal() {
            const modal = document.getElementById('macroModal');
            if (modal) modal.style.display = 'none';
        }

        function generateMacroPlanning() {
            const container = document.getElementById('macroContainer');
            if (!container) return;
            if (!projects || projects.length === 0) {
                container.innerHTML = '<p>Aucun projet disponible.</p>';
                return;
            }
            // Calculer la plage globale de dates pour tous les projets
            const allDates = [];
            projects.forEach(proj => {
                if (proj.tasks && proj.tasks.length) {
                    const startDates = proj.tasks.map(t => new Date(t.startDate));
                    const endDates = proj.tasks.map(t => new Date(t.endDate));
                    const minDate = new Date(Math.min(...startDates));
                    const maxDate = new Date(Math.max(...endDates));
                    allDates.push(minDate, maxDate);
                }
            });
            if (allDates.length === 0) {
                container.innerHTML = '<p>Aucune tâche dans les projets.</p>';
                return;
            }
            let globalStart = new Date(Math.min(...allDates));
            let globalEnd = new Date(Math.max(...allDates));
            // Ajouter une marge de quelques jours pour la visibilité
            globalStart.setDate(globalStart.getDate() - 7);
            globalEnd.setDate(globalEnd.getDate() + 7);
            const totalDays = (globalEnd - globalStart) / (1000 * 60 * 60 * 24);
            let html = '';
            projects.forEach(proj => {
                if (!proj.tasks || proj.tasks.length === 0) return;
                const startDates = proj.tasks.map(t => new Date(t.startDate));
                const endDates = proj.tasks.map(t => new Date(t.endDate));
                const projStartDate = new Date(Math.min(...startDates));
                const projEndDate = new Date(Math.max(...endDates));
                const startOffset = (projStartDate - globalStart) / (1000 * 60 * 60 * 24);
                const duration = (projEndDate - projStartDate) / (1000 * 60 * 60 * 24) + 1;
                const leftPct = (startOffset / totalDays) * 100;
                const widthPct = (duration / totalDays) * 100;
                // Milestones
                const milestones = proj.tasks.filter(t => t.type === 'milestone');
                let milestoneHtml = '';
                milestones.forEach(ms => {
                    const msDate = new Date(ms.startDate);
                    const msOffset = (msDate - globalStart) / (1000 * 60 * 60 * 24);
                    const msPct = (msOffset / totalDays) * 100;
                    milestoneHtml += `<div class="macro-milestone" style="left: ${msPct}%" title="${ms.name}"></div>`;
                });
                html += `
                    <div class="macro-row">
                        <div class="macro-name">${proj.name}</div>
                        <div class="macro-bar-container">
                            <div class="macro-bar" style="left: ${leftPct}%; width: ${widthPct}%;"></div>
                            ${milestoneHtml}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ------- Décomposition de problème -------
        function showDecomposeModal() {
            const modal = document.getElementById('decomposeModal');
            if (!modal) return;
            // Remplir les valeurs par défaut
            const startInput = document.getElementById('decomposeStartDate');
            if (startInput) {
                // Utiliser la date du jour ou la date de début du projet
                const today = new Date().toISOString().split('T')[0];
                startInput.value = today;
            }
            const durationInput = document.getElementById('decomposeDuration');
            if (durationInput) {
                durationInput.value = 5;
            }
            const typeSelect = document.getElementById('decomposeType');
            if (typeSelect) {
                typeSelect.value = 'normal';
            }
            const textArea = document.getElementById('problemText');
            if (textArea) textArea.value = '';
            modal.style.display = 'block';
        }

        function closeDecomposeModal() {
            const modal = document.getElementById('decomposeModal');
            if (modal) modal.style.display = 'none';
        }

        function handleDecomposeSubmit(e) {
            e.preventDefault();
            const text = document.getElementById('problemText').value;
            const startDateStr = document.getElementById('decomposeStartDate').value;
            const duration = parseInt(document.getElementById('decomposeDuration').value) || 1;
            const type = document.getElementById('decomposeType').value;
            if (!text.trim()) {
                showNotification('Veuillez saisir au moins une étape pour décomposer', 'error');
                return;
            }
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            if (lines.length === 0) {
                showNotification('Aucune ligne valide trouvée', 'error');
                return;
            }
            let currentStart = new Date(startDateStr || new Date());
            lines.forEach((line, index) => {
                const taskStart = new Date(currentStart);
                const taskEnd = new Date(currentStart);
                taskEnd.setDate(taskEnd.getDate() + duration - 1);
                const newTask = {
                    id: Date.now() + index,
                    name: line,
                    type: type,
                    startDate: taskStart.toISOString().split('T')[0],
                    endDate: taskEnd.toISOString().split('T')[0],
                    resources: '',
                    priority: 'normal',
                    progress: 0,
                    notes: ''
                };
                tasks.push(newTask);
                // Passer à la prochaine date de début
                currentStart.setDate(currentStart.getDate() + duration);
            });
            showNotification(`${lines.length} tâches générées`, 'success');
            // Mettre à jour ressources et interface
            updateResourcesFromTasks();
            renderResourceOptions();
            generateGantt();
            updateStats();
            closeDecomposeModal();
        }

        // ------- Gestion des projets -------
        function renderProjectSelect() {
            const select = document.getElementById('projectSelect');
            if (!select) return;
            select.innerHTML = '';
            projects.forEach(proj => {
                const option = document.createElement('option');
                option.value = proj.id;
                option.textContent = proj.name;
                if (proj.id === currentProjectId) option.selected = true;
                select.appendChild(option);
            });
        }

        /**
         * Met à jour la section affichant les détails du projet courant (nom,
         * description et notes).  Si aucun projet n'est sélectionné, la
         * section est masquée.
         */
        function renderProjectDetails() {
            const detailsEl = document.getElementById('projectDetails');
            if (!detailsEl) return;
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) {
                detailsEl.style.display = 'none';
                return;
            }
            // Remplir les champs
            const nameSpan = document.getElementById('projName');
            const descSpan = document.getElementById('projDescription');
            const notesSpan = document.getElementById('projNotes');
            if (nameSpan) nameSpan.textContent = project.name || '';
            if (descSpan) descSpan.textContent = project.description || '';
            if (notesSpan) notesSpan.textContent = project.notes || '';
            detailsEl.style.display = 'block';
        }

        function switchProject(projectId) {
            const idNum = parseInt(projectId);
            const project = projects.find(p => p.id === idNum);
            if (!project) return;
            currentProjectId = project.id;
            tasks = project.tasks;
            updateResourcesFromTasks();
            renderResourceOptions();
            generateGantt();
            updateStats();
            renderProjectDetails();
        }

        let editingProject = null;

        function showAddProjectModal() {
            // Réinitialiser la fenêtre modale pour un nouveau projet
            editingProject = null;
            document.getElementById('projectModalTitle').textContent = 'Nouveau projet';
            document.getElementById('projectForm').reset();
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('projectStart').value = todayStr;
            document.getElementById('projectEnd').value = todayStr;
            document.getElementById('projectModal').style.display = 'block';
        }

        function closeProjectModal() {
            const modal = document.getElementById('projectModal');
            if (modal) modal.style.display = 'none';
        }

        function handleProjectSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('projectName').value.trim();
            const start = document.getElementById('projectStart').value;
            const end = document.getElementById('projectEnd').value;
            const description = document.getElementById('projectDescription').value;
            const notes = document.getElementById('projectNotes').value;
            if (!name) {
                showNotification('Le nom du projet est obligatoire', 'error');
                return;
            }
            if (editingProject) {
                editingProject.name = name;
                editingProject.startDate = start;
                editingProject.endDate = end;
                editingProject.description = description;
                editingProject.notes = notes;
                showNotification('Projet modifié', 'success');
            } else {
                const newProject = {
                    id: Date.now(),
                    name: name,
                    startDate: start,
                    endDate: end,
                    description: description,
                    notes: notes,
                    tasks: []
                };
                projects.push(newProject);
                currentProjectId = newProject.id;
                tasks = newProject.tasks;
                showNotification('Projet ajouté', 'success');
            }
            renderProjectSelect();
            renderProjectDetails();
            renderResourceOptions();
            generateGantt();
            updateStats();
            closeProjectModal();
        }

        /**
         * Vider toutes les tâches du projet courant.  Demande confirmation à
         * l'utilisateur avant de supprimer irrémédiablement les données.  Met à
         * jour le Gantt, les statistiques et les ressources une fois les
         * tâches supprimées.
         */
        function resetPlanning() {
            const confirmation = confirm('Êtes-vous sûr de vouloir effacer toutes les tâches de ce projet ? Cette action est irréversible.');
            if (!confirmation) return;
            // Trouver le projet courant et vider sa liste de tâches
            const project = projects.find(p => p.id === currentProjectId);
            if (project) {
                project.tasks = [];
                tasks = project.tasks;
            } else {
                tasks = [];
            }
            // Réinitialiser la liste des ressources à partir de zéro
            updateResourcesFromTasks();
            renderResourceOptions();
            // Rafraîchir l'interface
            generateGantt();
            updateStats();
            renderProjectDetails();
            showNotification('Planning vidé avec succès', 'success');
        }
    </script>
</body>
</html>
